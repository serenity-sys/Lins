<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cidade Melhor - Lins - Denúncia Colaborativa</title>
    
    <!-- Configurações para Web App / Tela Inicial (Android e iOS) -->
    <meta name="theme-color" content="#059669">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Cidade Melhor - Lins">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- Ícone de Navegação (Favicon) e Apple Touch Icon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cmVjdCB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgcng9IjEwMCIgZmlsbD0iIzA1OTY2OSIvPjxwYXRoIGQ9Ik0yNTYgOTAgbC04MCA4MGgxNjB6IiBmaWxsPSIjYmJlYmJlIi8+PHBhdGggZD0iTTI1NiAxNjB2MjYyTTI1NiAxNjBjLTcwIDAtMTI2IDU2LTEyNiAxMjZzNTYgMTI2IDEyNiAxMjZzMTI2LTU2IDEyNi0xMjZtLTU2LTEyNi0xMjYtMTI2eiIgZmlsbD0ibm9uZSIgc3Ryb2tlPSJ3aGl0ZSIgc3Ryb2tlLXdpZHRoPSI0MCIvPjxwYXRoIGQ9Ik0yNTYgMjAwYy00NCAwLTgwIDM2LTgwIDgwczM2IDgwIDgwIDgwIDgwLTM2IDgwLTgwLTM2LTgwLTgwLTgweiIgZmlsbD0iIzEwYjk4MSIvPjwvU3ZnPg==">
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cmVjdCB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgcng9IjEwMCIgZmlsbD0iIzA1OTY2OSIvPjxwYXRoIGQ9Ik0yNTYgOTAgbC04MCA4MGgxNjB6IiBmaWxsPSIjYmJlYmJlIi8+PHBhdGggZD0iTTI1NiAxNjB2MjYyTTI1NiAxNjBjLTcwIDAtMTI2IDU2LTEyNiAxMjZzNTYgMTI2IDEyNiAxMjZzMTI2LTU2IDEyNi0xMjZtLTU2LTEyNi0xMjYtMTI2eiIgZmlsbD0ibm9uZSIgc3Ryb2tlPSJ3aGl0ZSIgc3Ryb2tlLXdpZHRoPSI0MCIvPjxwYXRoIGQ9Ik0yNTYgMjAwYy00NCAwLTgwIDM2LTgwIDgwczM2IDgwIDgwIDgwIDgwLTM2IDgwLTgwLTM2LTgwLTgwLTgweiIgZmlsbD0iIzEwYjk4MSIvPjwvU3ZnPg==">

    <!-- Manifest para Android -->
    <link rel="manifest" href='data:application/manifest+json,{"name":"Cidade Melhor - Lins","short_name":"CidadeMelhor","start_url":".","display":"standalone","background_color":"#059669","theme_color":"#059669","icons":[{"src":"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cmVjdCB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgcng9IjEwMCIgZmlsbD0iIzA1OTY2OSIvPjxwYXRoIGQ9Ik0yNTYgOTAgbC04MCA4MGgxNjB6IiBmaWxsPSIjYmJlYmJlIi8+PHBhdGggZD0iTTI1NiAxNjB2MjYyTTI1NiAxNjBjLTcwIDAtMTI2IDU2LTEyNiAxMjZzNTYgMTI2IDEyNiAxMjZzMTI2LTU2IDEyNi0xMjZtLTU2LTEyNi0xMjYtMTI2eiIgZmlsbD0ibm9uZSIgc3Ryb2tlPSJ3aGl0ZSIgc3Ryb2tlLXdpZHRoPSI0MCIvPjxwYXRoIGQ9Ik0yNTYgMjAwYy00NCAwLTgwIDM2LTgwIDgwczM2IDgwIDgwIDgwIDgwLTM2IDgwLTgwLTM2LTgwLTgwLTgweiIgZmlsbD0iIzEwYjk4MSIvPjwvU3ZnPg==","sizes":"512x512","type":"image/svg+xml","purpose":"any maskable"}]}'>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .bg-gradient-eco { background: linear-gradient(135deg, #059669 0%, #10b981 100%); }
        .report-card { transition: all 0.3s ease; position: relative; }
        .hidden-field { display: none; }
        
        .app-logo {
            width: 40px;
            height: 40px;
            background-color: #059669;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        #modalDelete {
            backdrop-filter: blur(4px);
            transition: opacity 0.2s ease;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans">

    <!-- Header -->
    <header class="bg-white shadow-md sticky top-0 z-50">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <div class="app-logo">
                    <svg width="25" height="25" viewBox="0 0 512 512" fill="white" xmlns="http://www.w3.org/2000/svg">
                        <path d="M256 90 l-80 80h160z" fill="#bbebbe"/>
                        <path d="M256 160v262M256 160c-70 0-126 56-126 126s56 126 126 126 126-56 126-126-56-126-126-126z" fill="none" stroke="white" stroke-width="40"/>
                        <circle cx="256" cy="286" r="80" fill="#10b981"/>
                    </svg>
                </div>
                <h1 class="text-2xl font-bold text-green-800 tracking-tight">Cidade Melhor - Lins</h1>
            </div>
            <span class="text-xs font-bold text-green-600 bg-green-50 px-3 py-1 rounded-full border border-green-100 uppercase">Acesso Público</span>
        </div>
    </header>

    <!-- Hero -->
    <section class="bg-gradient-eco text-white py-10 px-4">
        <div class="container mx-auto text-center">
            <h2 class="text-3xl md:text-4xl font-extrabold mb-2">Transforme sua cidade</h2>
            <p class="text-lg opacity-90">colabore agora, ajude sua cidade a ficar melhor</p>
        </div>
    </section>

    <main class="container mx-auto px-4 py-8">
        <div class="grid lg:grid-cols-2 gap-12">
            
            <!-- Formulário -->
            <div class="bg-white p-6 md:p-8 rounded-2xl shadow-xl border border-gray-100 h-fit">
                <h3 class="text-2xl font-bold mb-6 text-gray-700 flex items-center">
                    <i class="fas fa-bullhorn mr-3 text-green-600"></i> Registrar Ocorrência
                </h3>
                
                <form id="denunciaForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">1. Foto do Local:</label>
                        <label id="fotoContainer" class="relative flex flex-col w-full h-36 border-2 border-dashed border-green-200 hover:bg-green-50 transition cursor-pointer rounded-xl bg-gray-50 items-center justify-center overflow-hidden">
                            <div id="fotoPlaceholder" class="flex flex-col items-center justify-center">
                                <i class="fas fa-camera text-2xl text-green-500 mb-1"></i>
                                <span class="text-xs text-gray-500 px-2 text-center">Clique para selecionar foto</span>
                            </div>
                            <img id="fotoPreview" class="hidden absolute inset-0 w-full h-full object-cover" src="" alt="Preview">
                            <input type="file" id="fotoInput" class="hidden" accept="image/*" required />
                        </label>
                    </div>

                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">2. Categoria:</label>
                        <select id="categoriaSelect" class="w-full p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-green-500 outline-none" required onchange="toggleOutros()">
                            <option value="">Selecione...</option>
                            <optgroup label="Vias">
                                <option value="Buraco na rua">Buraco na rua</option>
                                <option value="Bueiro entupido">Bueiro entupido</option>
                                <option value="Calçadas quebradas">Calçadas quebradas</option>
                            </optgroup>
                            <optgroup label="Ambiente">
                                <option value="Lixo Irregular">Lixo Irregular</option>
                                <option value="Queimada">Queimada</option>
                                <option value="Foco de dengue">Foco de dengue</option>
                            </optgroup>
                            <optgroup label="Iluminação">
                                <option value="Poste com lâmpada queimada">Lâmpada queimada</option>
                                <option value="Fiação exposta">Fiação exposta</option>
                            </optgroup>
                            <option value="outros">Outros</option>
                        </select>
                    </div>

                    <div id="campoOutros" class="hidden-field bg-yellow-50 p-3 rounded-lg border border-yellow-200">
                        <label class="block text-sm font-bold text-yellow-800 mb-1">Especifique:</label>
                        <input type="text" id="inputOutros" class="w-full p-2 rounded border border-yellow-300 outline-none">
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <input type="text" id="bairroInput" class="p-3 rounded-lg border border-gray-300 outline-none" placeholder="Bairro" required>
                        <input type="text" id="ruaInput" class="p-3 rounded-lg border border-gray-300 outline-none" placeholder="Rua/Nº" required>
                    </div>

                    <textarea id="descricaoInput" class="w-full p-3 rounded-lg border border-gray-300 outline-none" rows="2" placeholder="Referência/Descrição"></textarea>

                    <button type="submit" id="btnEnviar" class="w-full bg-green-600 text-white py-4 rounded-xl font-bold text-lg hover:bg-green-700 shadow-lg transition-all active:scale-95">
                        Enviar
                    </button>
                </form>
            </div>

            <!-- Feed -->
            <div id="feedSection">
                <h3 class="text-2xl font-bold text-gray-700 mb-6 flex justify-between items-center">
                    Feed Colaborativo
                </h3>
                <div id="feedLista" class="space-y-4">
                    <p class="text-center text-gray-400">Conectando ao banco de dados...</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal de Confirmação de Exclusão -->
    <div id="modalDelete" class="hidden fixed inset-0 z-[100] bg-black bg-opacity-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-sm w-full p-6 text-center">
            <div class="w-16 h-16 bg-red-100 text-red-600 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-trash-alt text-2xl"></i>
            </div>
            <h3 class="text-xl font-bold text-gray-800 mb-2">Excluir Postagem?</h3>
            <p class="text-gray-500 mb-6">Você tem certeza de que quer apagar a postagem? Esta ação não pode ser desfeita.</p>
            <div class="flex space-x-3">
                <button onclick="window.closeDeleteModal()" class="flex-1 px-4 py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold rounded-xl transition">
                    Não
                </button>
                <button id="confirmDeleteBtn" class="flex-1 px-4 py-3 bg-red-600 hover:bg-red-700 text-white font-bold rounded-xl shadow-lg transition">
                    Sim
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "SUA_API_KEY",
            authDomain: "cidade-limpa-c0993.firebaseapp.com",
            projectId: "cidade-limpa-c0993",
            storageBucket: "cidade-limpa-c0993.appspot.com",
            messagingSenderId: "470994516198",
            appId: "1:470994516198:web:0b5638c81ca7978f1aa327"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let idParaExcluir = null;

        document.getElementById('fotoInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const preview = document.getElementById('fotoPreview');
                    preview.src = event.target.result;
                    preview.classList.remove('hidden');
                    document.getElementById('fotoPlaceholder').classList.add('hidden');
                };
                reader.readAsDataURL(file);
            }
        });

        async function compressAndConvert(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 1024;
                        let width = img.width;
                        let height = img.height;
                        if (width > MAX_WIDTH) {
                            height *= MAX_WIDTH / width;
                            width = MAX_WIDTH;
                        }
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', 0.7));
                    };
                };
            });
        }

        window.toggleOutros = () => {
            const select = document.getElementById('categoriaSelect');
            const campo = document.getElementById('campoOutros');
            campo.style.display = select.value === 'outros' ? 'block' : 'none';
        };

        document.getElementById('denunciaForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const btn = document.getElementById('btnEnviar');
            
            // Início imediato
            try {
                const fotoFile = document.getElementById('fotoInput').files[0];
                
                // Processa a imagem (necessário para o Base64)
                const fotoData = await compressAndConvert(fotoFile);

                // Envia para o Firebase (sem 'await' para ser instantâneo na interface)
                addDoc(collection(db, "denuncias"), {
                    categoria: document.getElementById('categoriaSelect').value === 'outros' ? document.getElementById('inputOutros').value : document.getElementById('categoriaSelect').value,
                    bairro: document.getElementById('bairroInput').value,
                    rua: document.getElementById('ruaInput').value,
                    descricao: document.getElementById('descricaoInput').value,
                    foto: fotoData,
                    status: 'Pendente',
                    alteracoesStatus: 0,
                    dataCriacao: Date.now(),
                    dataFormatada: new Date().toLocaleDateString('pt-BR')
                });

                // Reset Imediato do formulário
                this.reset();
                document.getElementById('fotoPreview').classList.add('hidden');
                document.getElementById('fotoPlaceholder').classList.remove('hidden');
                document.getElementById('campoOutros').style.display = 'none';
                
            } catch (err) {
                console.error(err);
                alert("Erro ao processar imagem.");
            }
        });

        const q = query(collection(db, "denuncias"), orderBy("dataCriacao", "desc"));
        onSnapshot(q, (snapshot) => {
            const lista = document.getElementById('feedLista');
            lista.innerHTML = '';
            if (snapshot.empty) {
                lista.innerHTML = '<p class="text-gray-400 italic text-center py-10">Nenhuma denúncia registrada em Lins.</p>';
                return;
            }
            snapshot.forEach((docSnap) => {
                const d = docSnap.data();
                const id = docSnap.id;
                const isResolvido = d.status === 'Resolvido';
                const card = document.createElement('div');
                card.className = `report-card bg-white rounded-xl border-l-8 ${isResolvido ? 'border-green-500' : 'border-yellow-500'} shadow-md overflow-hidden`;
                card.innerHTML = `
                    <div class="p-5">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <span class="text-[10px] font-bold px-2 py-1 rounded-full uppercase ${isResolvido ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'}">
                                    ${d.status}
                                </span>
                                <h4 class="font-bold text-lg text-gray-800 mt-1">${d.categoria}</h4>
                                <p class="text-xs text-gray-500"><i class="fas fa-map-marker-alt text-red-500 mr-1"></i> ${d.bairro} - ${d.rua}</p>
                            </div>
                            <div class="flex items-center space-x-2">
                                <button onclick="window.updateStatus('${id}', '${d.status}', ${d.alteracoesStatus})" class="text-[10px] bg-blue-50 text-blue-600 font-bold py-2 px-3 rounded-lg hover:bg-blue-600 hover:text-white transition">
                                    <i class="fas fa-sync"></i>
                                </button>
                                <button onclick="window.deleteDenuncia('${id}')" class="text-gray-400 hover:text-red-600 p-2">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        </div>
                        ${d.foto ? `<img src="${d.foto}" class="w-full h-32 object-cover rounded-lg mb-3">` : ''}
                        <p class="text-gray-600 text-xs italic">"${d.descricao || 'Sem descrição.'}"</p>
                    </div>
                `;
                lista.appendChild(card);
            });
        });

        window.updateStatus = async (id, currentStatus, count) => {
            if (count >= 3) return;
            const newStatus = currentStatus === 'Pendente' ? 'Resolvido' : 'Pendente';
            await updateDoc(doc(db, "denuncias", id), { status: newStatus, alteracoesStatus: count + 1 });
        };

        window.deleteDenuncia = (id) => {
            idParaExcluir = id;
            document.getElementById('modalDelete').classList.remove('hidden');
        };

        window.closeDeleteModal = () => {
            idParaExcluir = null;
            document.getElementById('modalDelete').classList.add('hidden');
        };

        document.getElementById('confirmDeleteBtn').addEventListener('click', async () => {
            if (idParaExcluir) {
                try {
                    await deleteDoc(doc(db, "denuncias", idParaExcluir));
                    window.closeDeleteModal();
                } catch (err) {
                    console.error("Erro ao apagar:", err);
                }
            }
        });
    </script>
</body>
</html>
